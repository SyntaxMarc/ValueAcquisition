<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MLB Dashboard</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#121212; color:#eee; }
  header { background:#1f1f1f; padding:1rem; text-align:center; font-size:1.5rem; font-weight:bold; }
  .container { padding:1rem; }
  .controls { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1rem; }
  button { padding:.5rem 1rem; border:none; border-radius:6px; cursor:pointer; background:#2e2e2e; color:#fff; }
  button:hover { background:#444; }
  .table-wrapper { overflow-x:auto; margin-bottom:2rem; }
  table { width:100%; border-collapse:collapse; min-width:700px; }
  th, td { padding:.6rem; border:1px solid #333; text-align:center; }
  th { background:#222; }
  tr:nth-child(even) { background:#1a1a1a; }
  .ev-positive { color:#4caf50; font-weight:bold; }
  .ev-medium { color:#ffeb3b; font-weight:bold; }
  .ev-negative { color:#f44336; font-weight:bold; }
</style>
</head>
<body>
<header>âš¾ MLB Value Betting Dashboard</header>
<div class="container">
  <div class="controls">
    <button onclick="loadGames()">ðŸ”„ Refresh Games</button>
    <button onclick="manualReset()">ðŸ•— Manual Reset</button>
  </div>

  <!-- Single Game Table -->
  <div class="table-wrapper">
    <table id="gamesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Home Team</th>
          <th>Away Team</th>
          <th>Home Odds</th>
          <th>Away Odds</th>
          <th>Home EV</th>
          <th>Away EV</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Strong Parlay Table -->
  <h3>ðŸ”¥ Strong Parlays for Today</h3>
  <div class="table-wrapper">
    <table id="parlayTable">
      <thead>
        <tr>
          <th>Legs (Teams)</th>
          <th>Combined EV %</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const ODDS_API_KEY = "6d667177117b78ce8b2c728ee4721cb9";
const ODDS_API_URL = `https://api.the-odds-api.com/v4/sports/baseball_mlb/odds/?regions=us&oddsFormat=decimal&apiKey=${ODDS_API_KEY}`;

function getIPCmockOdds(team) { return (Math.random()*(2.5-1.2)+1.2).toFixed(2); }
function calcEV(prob, odds) { return (prob*odds-1)*100; }

async function loadGames() {
  const tbody = document.querySelector("#gamesTable tbody");
  tbody.innerHTML="<tr><td colspan='8'>Loading...</td></tr>";
  try {
    const res = await fetch(ODDS_API_URL);
    if(!res.ok) throw new Error("API Error");
    const data = await res.json();
    tbody.innerHTML="";

    data.forEach(game=>{
      const home = game.home_team;
      const away = game.away_team;
      const bookmaker = game.bookmakers[0];
      const market = bookmaker.markets.find(m=>m.key==="h2h");
      if(!market) return;

      const oddsAPIhome = market.outcomes.find(o=>o.name===home)?.price;
      const oddsAPIaway = market.outcomes.find(o=>o.name===away)?.price;

      const ipcHome = getIPCmockOdds(home);
      const ipcAway = getIPCmockOdds(away);

      const probHome = 1/ipcHome;
      const probAway = 1/ipcAway;

      const evHome = calcEV(probHome, oddsAPIhome);
      const evAway = calcEV(probAway, oddsAPIaway);

      const noteHome = (evHome>0 && probHome>=0.7)?'ðŸ’Ž Value Bet':'';
      const noteAway = (evAway>0 && probAway>=0.7)?'ðŸ’Ž Value Bet':'';

      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${new Date(game.commence_time).toLocaleString()}</td>
        <td>${home}</td>
        <td>${away}</td>
        <td>${oddsAPIhome}</td>
        <td>${oddsAPIaway}</td>
        <td class="${evHome>=0?'ev-positive':'ev-negative'}">${evHome.toFixed(1)}%</td>
        <td class="${evAway>=0?'ev-positive':'ev-negative'}">${evAway.toFixed(1)}%</td>
        <td>${noteHome || noteAway}</td>
      `;
      tbody.appendChild(tr);
    });

    generateStrongParlays();

  } catch(err) {
    tbody.innerHTML="<tr><td colspan='8'>Error loading data</td></tr>";
  }
}

function manualReset() { alert("Manual reset triggered (Next upgrade: auto reset at 8PM PH)."); loadGames(); }

function generateStrongParlays() {
  const tbody = document.querySelector("#parlayTable tbody");
  tbody.innerHTML="";
  const rows = Array.from(document.querySelectorAll("#gamesTable tbody tr"));
  const strongLegs = [];
  rows.forEach(row=>{
    const homeEV=parseFloat(row.cells[5].innerText);
    const awayEV=parseFloat(row.cells[6].innerText);
    const homeProb = parseFloat(row.cells[3].innerText)/100;
    const awayProb = parseFloat(row.cells[4].innerText)/100;
    if(homeEV>0 && homeProb>=0.7) strongLegs.push({team:row.cells[1].innerText, odds:parseFloat(row.cells[3].innerText), prob:homeProb, ev:homeEV});
    if(awayEV>0 && awayProb>=0.7) strongLegs.push({team:row.cells[2].innerText, odds:parseFloat(row.cells[4].innerText), prob:awayProb, ev:awayEV});
  });

  if(strongLegs.length<2) return;

  // Generate 3,5,7-leg parlays
  [3,5,7].forEach(n=>{
    if(strongLegs.length<n) return;
    const legs = strongLegs.slice(0,n);
    const combinedEV = legs.reduce((acc,l)=>acc*l.prob*l.odds,1)-1;
    const tr = document.createElement("tr");
    let evClass = combinedEV>=0.5?'ev-positive':(combinedEV>=0?'ev-medium':'ev-negative');
    tr.innerHTML=`
      <td>${legs.map(l=>l.team).join(" | ")}</td>
      <td class="${evClass}">${(combinedEV*100).toFixed(1)}%</td>
      <td>ðŸ’Ž Strong Value Parlay (${n}-leg)</td>
    `;
    tbody.appendChild(tr);
  });
}

loadGames();
</script>
</body>
</html>
